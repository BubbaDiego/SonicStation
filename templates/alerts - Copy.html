{% extends "sonic_admin.html" %}
{% block content %}

<style>
  /* Card backgrounds */
  .alert-box.card {
    background-color: #F0F0F0 !important;
    border: 2px solid #ccc;
    border-radius: 8px;
  }
  .alert-box .card-header {
    background-color: #e5ffe5 !important;
    font-weight: bold;
  }

  /* Table striping */
  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.05);
  }
  /* Title row styling */
  .title-row {
    background-color: #f0e5ff !important; /* Light purple */
    font-weight: bold;
  }

  .card.add-alert {
    background-color: #F0F0F0 !important;
    border: 2px solid #ccc;
    border-radius: 8px;
  }
  .card.add-alert .card-header {
    background-color: #e5ffe5 !important;
    font-weight: bold;
  }
</style>

<!-- ====== SECTION 1: Title + "Check Alerts" Button + Info Boxes ====== -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="text-dark mb-0">Alerts</h2>
  <!-- POST to /manual_check_alerts -->
  <form method="POST" action="{{ url_for('manual_check_alerts') }}" id="updateAlertsForm">
    <button type="submit" class="btn btn-success">Check Alerts</button>
  </form>
</div>

<!-- Row of 3 info boxes (Active Alerts, Triggered Today, Disabled Alerts) -->
<div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
  <div class="col">
    <div class="card alert-box h-100">
      <div class="card-header text-center">Active Alerts</div>
      <div class="card-body text-center">
        <div class="display-6 mb-2">
          {{ active_alerts_count or 0 }}
        </div>
        <small class="text-muted">Currently Enabled</small>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card alert-box h-100">
      <div class="card-header text-center">Triggered Today</div>
      <div class="card-body text-center">
        <div class="display-6 mb-2">
          {{ triggered_today_count or 0 }}
        </div>
        <small class="text-muted">Times Fired</small>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card alert-box h-100">
      <div class="card-header text-center">Disabled Alerts</div>
      <div class="card-body text-center">
        <div class="display-6 mb-2">
          {{ disabled_alerts_count or 0 }}
        </div>
        <small class="text-muted">Not Active</small>
      </div>
    </div>
  </div>
</div>

<!-- ====== SECTION 2: Two-Column Layout ======
     LEFT COLUMN = "Active Alerts" 
     RIGHT COLUMN = "Recent Alerts"
-->
<div class="row">
  <!-- LEFT COLUMN: Active Alerts -->
  <div class="col-md-6">
    <div class="card mb-4" style="background-color: #F0F0F0;">
      <div class="card-body p-2">
        <table class="table table-striped w-100 mb-0">
          <thead>
            <!-- Title row -->
            <tr class="title-row">
              <th colspan="4">Active Alerts</th>
            </tr>
            <tr>
              <th>Type</th>
              <th>Trigger Value</th>
              <th>Last Triggered</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% if active_alerts is not defined %}
              {% set active_alerts = [] %}
            {% endif %}
            {% for alert in active_alerts %}
            <tr>
              <td>{{ alert.alert_type }}</td>
              <td>{{ alert.trigger_value }}</td>
              <td>{{ alert.last_triggered or "N/A" }}</td>
              <td>
                {% if alert.status == "Active" %}
                  <span class="badge bg-success">Active</span>
                {% elif alert.status == "Disabled" %}
                  <span class="badge bg-secondary">Disabled</span>
                {% else %}
                  <span class="badge bg-warning">{{ alert.status }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN: Recent Alerts -->
  <div class="col-md-6">
    <div class="card mb-4" style="background-color: #F0F0F0;">
      <div class="card-body p-2">
        <table class="table table-striped w-100 mb-0">
          <thead>
            <!-- Title row with “Recent Alerts” + example pagination placeholder -->
            <tr class="title-row">
              <th colspan="4">
                Recent Alerts
                <nav class="float-end" style="display: inline-block;">
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item disabled">
                      <a class="page-link" href="#" tabindex="-1">«</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item"><a class="page-link" href="#">»</a></li>
                  </ul>
                </nav>
              </th>
            </tr>
            <tr>
              <th>Type</th>
              <th>Trigger Value</th>
              <th>Last Triggered</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% if recent_alerts is not defined %}
              {% set recent_alerts = [] %}
            {% endif %}
            {% for alert in recent_alerts %}
            <tr>
              <td>{{ alert.alert_type }}</td>
              <td>{{ alert.trigger_value }}</td>
              <td>{{ alert.last_triggered or "N/A" }}</td>
              <td>
                {% if alert.status == "Active" %}
                  <span class="badge bg-success">Active</span>
                {% elif alert.status == "Disabled" %}
                  <span class="badge bg-secondary">Disabled</span>
                {% else %}
                  <span class="badge bg-warning">{{ alert.status }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ====== SECTION 3: "Add New Alert" Form ====== -->
<div class="card add-alert">
  <div class="card-header">Add New Alert</div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('alerts_create') }}">
      <div class="row g-3">
        <!-- Alert Type -->
        <div class="col-md-4">
          <label for="alert_type" class="form-label fw-bold">Alert Type</label>
          <select class="form-select" id="alert_type" name="alert_type" required>
            <option value="PRICE_THRESHOLD">Price Threshold</option>
            <option value="TRAVEL_PERCENT">Travel Percent</option>
            <option value="DELTA_CHANGE">Delta Change</option>
          </select>
        </div>
        <!-- Trigger Value -->
        <div class="col-md-4">
          <label for="trigger_value" class="form-label fw-bold">Trigger Value</label>
          <input
            type="number"
            step="0.1"
            class="form-control"
            id="trigger_value"
            name="trigger_value"
            required
          />
        </div>
        <!-- Status -->
        <div class="col-md-4">
          <label for="status" class="form-label fw-bold">Status</label>
          <select class="form-select" id="status" name="status" required>
            <option value="Active" selected>Active</option>
            <option value="Disabled">Disabled</option>
          </select>
        </div>
        <!-- Notification Type -->
        <div class="col-md-4">
          <label for="notification_type" class="form-label fw-bold">Notification</label>
          <select class="form-select" id="notification_type" name="notification_type" required>
            <option value="SMS">SMS</option>
            <option value="EMAIL">Email</option>
            <option value="ACTION">Action</option>
          </select>
        </div>
        <!-- Position Reference (Optional) -->
        <div class="col-md-4">
          <label for="position_ref" class="form-label fw-bold">Position (Optional)</label>
          <input
            type="text"
            class="form-control"
            id="position_ref"
            name="position_reference_id"
            placeholder="e.g. position ID"
          />
        </div>
        <!-- Submit Button -->
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Add Alert</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ====== SECTION 4: JavaScript to Intercept “Check Alerts” & Reload ====== -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const updateAlertsForm = document.getElementById('updateAlertsForm');
    if (updateAlertsForm) {
      updateAlertsForm.addEventListener('submit', (event) => {
        event.preventDefault(); // Prevent normal form submission

        fetch('{{ url_for("manual_check_alerts") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server returned status ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Check Alerts response:', data);
          // Reload the page to see updated data
          window.location.reload();
        })
        .catch(err => {
          console.error('Error checking alerts:', err);
          alert(`Failed to check alerts: ${err.message}`);
        });
      });
    }
  });
</script>

{% endblock %}
